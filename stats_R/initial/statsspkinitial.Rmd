---
title: "stats"
author: "Yuqing Zhang"
date: "2024-01-24"
output: html_document
---

```{r setup, include=FALSE}

# Install the required packages if they are not installed
packages <- c("lme4", "tidyverse", "Matrix", "brms")
new_packages <- packages[!(packages %in% installed.packages()[, "Package"])]

if (length(new_packages) > 0) {
  install.packages(new_packages)
}

# Load the libraries
library(lme4)
library(tidyverse)
library(Matrix)
library(brms)


# Directory where the CSV files are located
directory <- "./speaking"

# List to store data from each file
data <- list()

# Iterate over each file in the directory
files <- list.files(directory, pattern = "\\.csv$", full.names = TRUE)
for (file in files) {
  # Extract information from the file name
  # drop_value <- ifelse(str_detect(file, "0\\.2"), TRUE, FALSE)
#  drop_value <- case_when(
#    str_detect(file, "0\\.1") ~ "0.1",
#    str_detect(file, "0\\.2") ~ "0.2",
#    TRUE ~ "0"
#)
  skew_type <- ifelse(str_detect(file, "skewed"), TRUE, FALSE)
  lang_value <- case_when(
    str_detect(file, "long") ~ "long",
    str_detect(file, "local") ~ "local",
    TRUE ~ "mix"
  )
  
  # Read the CSV file
  # df <- read.csv(file)
  df <- read.delim(file)

  # Add columns to the data frame
  df <- df %>% mutate(skew = skew_type, lang = lang_value)

  # Append to the list
  data <- append(data, list(df))
}

# Combine all data frames into a single data frame
combined_data <- bind_rows(data)

selected_data <- combined_data %>%
  select(multi_acc, epoch, skew, lang)

selected_data$epoch_c <- scale(selected_data$epoch)
selected_data$epoch_end <- scale(selected_data$epoch, center = 60, scale = 60)

selected_data$subject <- rep(1:(nrow(selected_data) / 60), each = 60)

selected_data$lang <- factor(selected_data$lang)
selected_data$skew <- factor(selected_data$skew)
selected_data$subject <- factor(selected_data$subject)

# Save the combined data frame to a new CSV file
# write.csv(selected_data, "./combined_dataspkinitial.csv", row.names = FALSE)

```




```{r}
spkinitial.model <- brm(multi_acc ~ epoch_end * skew * lang + (1|subject),
                data = selected_data,
                warmup = 2000, iter = 4000,
                cores = 4, chains = 4#,
                #control = list(adapt_delta = 0.99, max_treedepth = 15)
                )
print(summary(spkinitial.model), digits = 3)
mcmc_plot(spkinitial.model)
```




```{r}
spkinitial.model2 <- brm(multi_acc ~ epoch_end + skew * lang + (1|subject),
                data = selected_data,
                warmup = 2000, iter = 4000,
                cores = 4, chains = 4#,
                #control = list(adapt_delta = 0.99, max_treedepth = 15)
                )
print(summary(spkinitial.model2), digits = 3)
mcmc_plot(spkinitial.model2)
```



```{r}
library(ggplot2)
library(dplyr)
library(readr)
library(stringr)
library(purrr)
library(tidyr)

df_lang_by_drop <- list()

plot_rate_in_one_spk <- function(plot_df, subset, drop, plot_type, added_labels) {
  # Define the fixed color order
  color_map <- c(
    "skewedlocal" = "#1A2C47",
    "skewed" = "#3273B3",
    "skewedlong" = "#A8D8F0",
    "uniformlocal" = "#8B0000",
    "uniform" = "#E27A7A",
    "uniformlong" = "#FFD1D1"
  )

  # Ensure factor levels match the desired order
  plot_df$lang <- factor(plot_df$lang, 
                         levels = c("skewedlocal", "skewed", "skewedlong", 
                                    "uniformlocal", "uniform", "uniformlong"))

  # Create the plot
  p <- ggplot(plot_df, aes(x = epoch, y = mean, color = lang, group = lang)) +
    geom_line(size = 1) +
    geom_errorbar(aes(ymin = mean - 1.96 * sem, ymax = mean + 1.96 * sem), width = 0.2) +
    scale_color_manual(values = color_map) +  # Apply fixed color order
    labs(x = "Epochs", y = "Accuracy", color = "Language Type") +
    theme_minimal(base_size = 15)

  print(p)  # Ensure the plot is displayed when the function is called
}

rate_acc_spk <- function(folder_path, lang, subset, plot_type, drops, spkhidden, lsthidden) {
  for (drop in drops) {
    file_list <- list.files(folder_path, pattern = paste0("train_langinitial_.*_split.*_spkhidden", spkhidden, "_lsthidden", lsthidden, ".*_drop", drop, "_seed.*_spk.txt"), full.names = TRUE)
    
    df_lang_by_drop[[as.character(drop)]] <- list()

    for (file_path in file_list) {
      df <- read_tsv(file_path, show_col_types = FALSE)
      lang_v <- str_extract(basename(file_path), "train_langinitial_([^_]*)") %>% str_replace("train_langinitial_", "")
      
      if (lang_v %in% lang) {
        if (!lang_v %in% names(df_lang_by_drop[[as.character(drop)]])) {
          df_lang_by_drop[[as.character(drop)]][[lang_v]] <- list()
        }
        df_lang_by_drop[[as.character(drop)]][[lang_v]] <- append(df_lang_by_drop[[as.character(drop)]][[lang_v]], list(df))
      }
    }
  }

  for (drop in drops) {
    df_combined_lang <- map(df_lang_by_drop[[as.character(drop)]], ~ bind_rows(.x))
    
    plot_data <- list()

    for (k in names(df_combined_lang)) {
      df_train <- df_combined_lang[[k]] %>% filter(mode == "train")
      df_test <- df_combined_lang[[k]] %>% filter(mode == "test")

      test_stats <- df_test %>% 
        group_by(epoch) %>% 
        summarise(mean = mean(multi_acc, na.rm = TRUE),
                  std = sd(multi_acc, na.rm = TRUE),
                  sem = std / sqrt(n()),
                  .groups = 'drop') %>%
        slice(1:subset)

      plot_data[[k]] <- test_stats %>% mutate(lang = k)
    }

    plot_df <- bind_rows(plot_data)

    # Call the plotting function
    plot_rate_in_one_spk(plot_df, subset, drop, plot_type, added_labels = c())
  }

  # Save the plot
  ggsave("./plot/initial_spk_acc_rnn.pdf", width = 8, height = 15, dpi = 300)
}

# Example usage
lang <- c("skewedlocal", "skewed", "skewedlong", "uniformlocal", "uniform", "uniformlong")
spkhidden <- 512
lsthidden <- 512
drops <- c(0)

rate_acc_spk(
  "./training_log",
  lang = lang,
  subset = 60,
  plot_type = "acc",
  drops = drops,
  spkhidden = spkhidden,
  lsthidden = lsthidden
)

ggsave("spk_acc.pdf", width = 8, height = 15, dpi = 300)
```




